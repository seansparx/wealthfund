!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)}(function(a){"use strict";function b(a,b,c){this.regExpFactory=a,this.state=b,this.stream=c,this.styles=d,this.state.specialChar=null}function c(){this.cache={},this.single={bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},this.attributes={align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/}}var d={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};b.prototype.eat=function(a){return this.stream.match(this.regExpFactory.pattern(a),!0)},b.prototype.check=function(a){return this.stream.match(this.regExpFactory.pattern(a),!1)},b.prototype.setModeForNextToken=function(a){return this.state.mode=a},b.prototype.execMode=function(a){return this.setModeForNextToken(a).call(this)},b.prototype.startNewLine=function(){this.setModeForNextToken(e.newLayout),this.state.tableHeading=!1,"definitionList"===this.state.layoutType&&this.state.spanningLayout&&this.check("definitionListEnd")&&(this.state.spanningLayout=!1)},b.prototype.nextToken=function(){return this.state.mode.call(this)},b.prototype.styleFor=function(a){if(this.styles.hasOwnProperty(a))return this.styles[a];throw"unknown token"},b.prototype.handlePhraseModifier=function(a){if("_"===a)return this.stream.eat("_")?this.togglePhraseModifier("italic",/^.*__/):this.togglePhraseModifier("em",/^.*_/);if("*"===a)return this.stream.eat("*")?this.togglePhraseModifier("bold",/^.*\*\*/):this.togglePhraseModifier("strong",/^.*\*/);if("["===a)return this.stream.match(/\d+\]/)&&(this.state.footCite=!0),this.tokenStyles();if("("===a)return this.stream.match("r)")?this.state.specialChar="r":this.stream.match("tm)")?this.state.specialChar="tm":this.stream.match("c)")&&(this.state.specialChar="c"),this.tokenStyles();if("<"===a&&this.stream.match(/(\w+)[^>]+>[^<]+<\/\1>/))return this.tokenStylesWith(this.styleFor("html"));if("?"===a&&this.stream.eat("?"))return this.togglePhraseModifier("cite",/^.*\?\?/);if("="===a&&this.stream.eat("="))return this.togglePhraseModifier("notextile",/^.*==/);if("-"===a)return this.togglePhraseModifier("deletion",/^.*-/);if("+"===a)return this.togglePhraseModifier("addition",/^.*\+/);if("~"===a)return this.togglePhraseModifier("sub",/^.*~/);if("^"===a)return this.togglePhraseModifier("sup",/^.*\^/);if("%"===a)return this.togglePhraseModifier("span",/^.*%/);if("@"===a)return this.togglePhraseModifier("code",/^.*@/);if("!"===a){var b=this.togglePhraseModifier("image",/^.*(?:\([^\)]+\))?!/);return this.stream.match(/^:\S+/),b}return this.tokenStyles()},b.prototype.togglePhraseModifier=function(a,b){if(this.state[a]){var c=this.tokenStyles();return this.state[a]=!1,c}return this.stream.match(b,!1)&&(this.state[a]=!0,this.setModeForNextToken(e.attributes)),this.tokenStyles()},b.prototype.tokenStyles=function(){var a=this.textileDisabled(),b=[];return a?a:(this.state.layoutType&&b.push(this.styleFor(this.state.layoutType)),b=b.concat(this.activeStyles("addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","specialChar","strong","sub","sup","table","tableHeading")),"header"===this.state.layoutType&&b.push(this.styleFor("header")+"-"+this.state.header),b.length?b.join(" "):null)},b.prototype.textileDisabled=function(){var a=this.state.layoutType;switch(a){case"notextile":case"code":case"pre":return this.styleFor(a);default:return this.state.notextile?this.styleFor("notextile")+(a?" "+this.styleFor(a):""):null}},b.prototype.tokenStylesWith=function(a){var b,c=this.textileDisabled();return c?c:(b=this.tokenStyles(),a?b?b+" "+a:a:b)},b.prototype.activeStyles=function(){var a,b=[];for(a=0;a<arguments.length;++a)this.state[arguments[a]]&&b.push(this.styleFor(arguments[a]));return b},b.prototype.blankLine=function(){var a,b=this.state.spanningLayout,c=this.state.layoutType;for(a in this.state)this.state.hasOwnProperty(a)&&delete this.state[a];this.setModeForNextToken(e.newLayout),b&&(this.state.layoutType=c,this.state.spanningLayout=!0)},c.prototype.pattern=function(a){return this.cache[a]||this.createRe(a)},c.prototype.createRe=function(a){switch(a){case"drawTable":return this.makeRe("^",this.single.drawTable,"$");case"html":return this.makeRe("^",this.single.html,"(?:",this.single.html,")*","$");case"linkDefinition":return this.makeRe("^",this.single.linkDefinition,"$");case"listLayout":return this.makeRe("^",this.single.list,this.pattern("allAttributes"),"*\\s+");case"tableCellAttributes":return this.makeRe("^",this.choiceRe(this.single.tableCellAttributes,this.pattern("allAttributes")),"+\\.");case"type":return this.makeRe("^",this.pattern("allTypes"));case"typeLayout":return this.makeRe("^",this.pattern("allTypes"),this.pattern("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return this.makeRe("^",this.pattern("allAttributes"),"+");case"allTypes":return this.choiceRe(this.single.div,this.single.foot,this.single.header,this.single.bc,this.single.bq,this.single.notextile,this.single.pre,this.single.table,this.single.para);case"allAttributes":return this.choiceRe(this.attributes.selector,this.attributes.css,this.attributes.lang,this.attributes.align,this.attributes.pad);default:return this.makeRe("^",this.single[a])}},c.prototype.makeRe=function(){var a,b,c="";for(a=0;a<arguments.length;++a)b=arguments[a],c+="string"==typeof b?b:b.source;return new RegExp(c)},c.prototype.choiceRe=function(){var a,b=[arguments[0]];for(a=1;a<arguments.length;++a)b[2*a-1]="|",b[2*a]=arguments[a];return b.unshift("(?:"),b.push(")"),this.makeRe.apply(this,b)};var e={newLayout:function(){if(this.check("typeLayout"))return this.state.spanningLayout=!1,this.execMode(e.blockType);if(!this.textileDisabled()){if(this.check("listLayout"))return this.execMode(e.list);if(this.check("drawTable"))return this.execMode(e.table);if(this.check("linkDefinition"))return this.execMode(e.linkDefinition);if(this.check("definitionList"))return this.execMode(e.definitionList);if(this.check("html"))return this.execMode(e.html)}return this.execMode(e.text)},blockType:function(){var a,b;return this.state.layoutType=null,(a=this.eat("type"))?(b=a[0],(a=b.match(this.regExpFactory.pattern("header")))?(this.state.layoutType="header",this.state.header=parseInt(a[0][1])):b.match(this.regExpFactory.pattern("bq"))?this.state.layoutType="quote":b.match(this.regExpFactory.pattern("bc"))?this.state.layoutType="code":b.match(this.regExpFactory.pattern("foot"))?this.state.layoutType="footnote":b.match(this.regExpFactory.pattern("notextile"))?this.state.layoutType="notextile":b.match(this.regExpFactory.pattern("pre"))?this.state.layoutType="pre":b.match(this.regExpFactory.pattern("div"))?this.state.layoutType="div":b.match(this.regExpFactory.pattern("table"))&&(this.state.layoutType="table"),this.setModeForNextToken(e.attributes),this.tokenStyles()):this.execMode(e.text)},text:function(){if(this.eat("text"))return this.tokenStyles();var a=this.stream.next();return'"'===a?this.execMode(e.link):this.handlePhraseModifier(a)},attributes:function(){return this.setModeForNextToken(e.layoutLength),this.eat("attributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},layoutLength:function(){return this.stream.eat(".")&&this.stream.eat(".")&&(this.state.spanningLayout=!0),this.setModeForNextToken(e.text),this.tokenStyles()},list:function(){var a,b=this.eat("list");return this.state.listDepth=b[0].length,a=(this.state.listDepth-1)%3,a?1===a?this.state.layoutType="list2":this.state.layoutType="list3":this.state.layoutType="list1",this.setModeForNextToken(e.attributes),this.tokenStyles()},link:function(){return this.setModeForNextToken(e.text),this.eat("link")?(this.stream.match(/\S+/),this.tokenStylesWith(this.styleFor("link"))):this.tokenStyles()},linkDefinition:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("linkDefinition"))},definitionList:function(){return this.eat("definitionList"),this.state.layoutType="definitionList",this.stream.match(/\s*$/)?this.state.spanningLayout=!0:this.setModeForNextToken(e.attributes),this.tokenStyles()},html:function(){return this.stream.skipToEnd(),this.tokenStylesWith(this.styleFor("html"))},table:function(){return this.state.layoutType="table",this.execMode(e.tableCell)},tableCell:function(){return this.eat("tableHeading")?this.state.tableHeading=!0:this.stream.eat("|"),this.setModeForNextToken(e.tableCellAttributes),this.tokenStyles()},tableCellAttributes:function(){return this.setModeForNextToken(e.tableText),this.eat("tableCellAttributes")?this.tokenStylesWith(this.styleFor("attributes")):this.tokenStyles()},tableText:function(){return this.eat("tableText")?this.tokenStyles():"|"===this.stream.peek()?(this.setModeForNextToken(e.tableCell),this.tokenStyles()):this.handlePhraseModifier(this.stream.next())}};a.defineMode("textile",function(){var a=new c;return{startState:function(){return{mode:e.newLayout}},token:function(c,d){var e=new b(a,d,c);return c.sol()&&e.startNewLine(),e.nextToken()},blankLine:function(c){new b(a,c).blankLine()}}}),a.defineMIME("text/x-textile","textile")});