!function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../smarty/smarty")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../smarty/smarty"],a):a(CodeMirror)}(function(a){"use strict";a.defineMode("smartymixed",function(b){function c(a){return a.replace(/[^\s\w]/g,"\\$&")}var d=a.getMode(b,"htmlmixed"),e=a.getMode(b,"smarty"),f={rightDelimiter:"}",leftDelimiter:"{"};b.hasOwnProperty("leftDelimiter")&&(f.leftDelimiter=b.leftDelimiter),b.hasOwnProperty("rightDelimiter")&&(f.rightDelimiter=b.rightDelimiter);var g=c(f.leftDelimiter),h=c(f.rightDelimiter),i={smartyComment:new RegExp("^"+h+"\\*"),literalOpen:new RegExp(g+"literal"+h),literalClose:new RegExp(g+"/literal"+h),hasLeftDelimeter:new RegExp(".*"+g),htmlHasLeftDelimeter:new RegExp("[^<>]*"+g)},j={chain:function(a,b,c){return b.tokenize=c,c(a,b)},cleanChain:function(a,b,c){return b.tokenize=null,b.localState=null,b.localMode=null,"string"==typeof c?c?c:null:c(a,b)},maybeBackup:function(a,b,c){var d,e=a.current(),f=e.search(b);return f>-1?a.backUp(e.length-f):(d=e.match(/<\/?$/))&&(a.backUp(e.length),a.match(b,!1)||a.match(e[0])),c}},k={html:function(a,b){var c=b.htmlMixedState.htmlState.context&&b.htmlMixedState.htmlState.context.tagName?b.htmlMixedState.htmlState.context.tagName:null;return!b.inLiteral&&a.match(i.htmlHasLeftDelimeter,!1)&&null===c?(b.tokenize=k.smarty,b.localMode=e,b.localState=e.startState(d.indent(b.htmlMixedState,"")),j.maybeBackup(a,f.leftDelimiter,e.token(a,b.localState))):!b.inLiteral&&a.match(f.leftDelimiter,!1)?(b.tokenize=k.smarty,b.localMode=e,b.localState=e.startState(d.indent(b.htmlMixedState,"")),j.maybeBackup(a,f.leftDelimiter,e.token(a,b.localState))):d.token(a,b.htmlMixedState)},smarty:function(a,b){if(a.match(f.leftDelimiter,!1)){if(a.match(i.smartyComment,!1))return j.chain(a,b,k.inBlock("comment","*"+f.rightDelimiter))}else if(a.match(f.rightDelimiter,!1))return a.eat(f.rightDelimiter),b.tokenize=k.html,b.localMode=d,b.localState=b.htmlMixedState,"tag";return j.maybeBackup(a,f.rightDelimiter,e.token(a,b.localState))},inBlock:function(a,b){return function(c,d){for(;!c.eol();){if(c.match(b)){j.cleanChain(c,d,"");break}c.next()}return a}}};return{startState:function(){var a=d.startState();return{token:k.html,localMode:null,localState:null,htmlMixedState:a,tokenize:null,inLiteral:!1}},copyState:function(b){var c=null,f=b.tokenize||b.token;return b.localState&&(c=a.copyState(f!=k.html?e:d,b.localState)),{token:b.token,tokenize:b.tokenize,localMode:b.localMode,localState:c,htmlMixedState:a.copyState(d,b.htmlMixedState),inLiteral:b.inLiteral}},token:function(a,b){if(a.match(f.leftDelimiter,!1)){if(!b.inLiteral&&a.match(i.literalOpen,!0))return b.inLiteral=!0,"keyword";if(b.inLiteral&&a.match(i.literalClose,!0))return b.inLiteral=!1,"keyword"}b.inLiteral&&b.localState!=b.htmlMixedState&&(b.tokenize=k.html,b.localMode=d,b.localState=b.htmlMixedState);var c=(b.tokenize||b.token)(a,b);return c},indent:function(b,c){return b.localMode==e||b.inLiteral&&!b.localMode||i.hasLeftDelimeter.test(c)?a.Pass:d.indent(b.htmlMixedState,c)},innerMode:function(a){return{state:a.localState||a.htmlMixedState,mode:a.localMode||d}}}},"htmlmixed","smarty"),a.defineMIME("text/x-smarty","smartymixed")});